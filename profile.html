<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="icon" href="Images/favicon.ico" type="image/x-icon">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile | NearbyNow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        fade: "fadeIn 0.4s ease-in-out",
                    },
                    keyframes: {
                        fadeIn: {
                            from: { opacity: 0 },
                            to: { opacity: 1 },
                        },
                    },
                },
            },
        };
    </script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col md:flex-row">

    <!-- Sidebar for desktop -->
    <aside class="hidden md:flex md:flex-col bg-white w-50 p-6 shadow-lg space-y-6">
        <div class="flex items-center space-x-3">
            <img src="Images/profile.png" class="w-11 h-11 rounded-full" alt="Profile" />
            <span class="text-lg font-bold">NearbyNow</span>
        </div>
        <nav class="space-y-5 text-base">
            <a href="home.html" class="flex items-center gap-2 hover:text-indigo-600 font-medium">Home</a>
            <a href="add-message.html" class="flex items-center gap-2 hover:text-indigo-600 font-medium">Add Post</a>
            <a href="notifications.html"
                class="flex items-center gap-2 hover:text-indigo-600 font-medium">Notifications</a>
            <a href="profile.html" class="flex items-center gap-2 hover:text-indigo-600 font-medium">Profile</a>
            <a href="settings.html" class="flex items-center gap-2 hover:text-indigo-600 font-medium">Settings</a>
            <a href="index.html" class="flex items-center gap-2 hover:text-indigo-600 font-medium">Logout</a>
        </nav>
    </aside>

    <!-- Main content -->
    <main class="flex-1 flex flex-col">

        <!-- Mobile Header -->
        <header class="md:hidden bg-white p-4 flex justify-between items-center shadow relative">
            <img src="Images/profile.png" alt="" class="w-9 h-9 rounded-full" />
            <h1 class="text-lg font-bold">NearbyNow</h1>

            <!-- Hamburger button -->
            <button id="hamburgerBtn" aria-label="Menu" aria-expanded="false"
                class="text-gray-800 text-3xl p-2 rounded-full hover:bg-gray-200 transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                &#9776; <!-- hamburger icon -->
            </button>

            <!-- Dropdown menu (hidden by default) -->
            <div id="hamburgerMenu"
                class="hidden absolute top-full right-4 mt-2 w-36 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
                <a href="settings.html"
                    class="block px-4 py-2 text-gray-700 hover:bg-indigo-600 hover:text-white rounded-t-lg">Settings</a>
                <button id="logoutBtn"
                    class="w-full text-left px-4 py-2 text-gray-700 hover:bg-indigo-600 hover:text-white rounded-b-lg">Logout</button>
            </div>
        </header>

        <!-- Profile Content -->
        <section class="p-4 max-w-2xl mx-auto w-full space-y-6 animate-fade">

            <!-- Profile View -->
            <div id="profileContainer" class="bg-white rounded-xl shadow p-6 space-y-6">

                <div class="flex flex-col items-center space-y-4">
                    <h2 id="name" class="text-2xl font-bold text-gray-800"></h2>
                    <button id="editProfile"
                        class="text-sm px-4 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 hidden">
                        Edit Profile
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-4 text-gray-700">
                    <div>
                        <p class="text-sm font-semibold">Mobile</p>
                        <p id="mobile" class="text-base"></p>
                    </div>
                    <div>
                        <p class="text-sm font-semibold">Email</p>
                        <p id="email" class="text-base break-words"></p>
                    </div>
                    <div>
                        <p class="text-sm font-semibold">Gender</p>
                        <p id="gender" class="text-base"></p>
                    </div>
                    <div>
                        <p class="text-sm font-semibold">Age</p>
                        <p id="age" class="text-base"></p>
                    </div>
                    <div class="col-span-2">
                        <p class="text-sm font-semibold">Address</p>
                        <p id="address" class="text-base"></p>
                    </div>
                    <div class="col-span-2">
                        <p class="text-sm font-semibold">About</p>
                        <p id="about" class="text-base"></p>
                    </div>
                </div>

            </div>

            <!-- Profile Form -->
            <div id="formContainer" class="hidden bg-white rounded-xl shadow p-6">
                <h2 class="text-xl font-bold mb-4 text-gray-800">Fill your profile</h2>
                <form id="profileForm" class="space-y-4">
                    <input type="text" name="name" placeholder="Name" required class="w-full border p-2 rounded" />
                    <input type="tel" name="mobile" placeholder="Mobile No" required
                        class="w-full border p-2 rounded" />
                    <select name="gender" required class="w-full border p-2 rounded">
                        <option value="">Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                    <input type="number" name="age" placeholder="Age" required class="w-full border p-2 rounded" />
                    <input type="text" name="address" placeholder="Address" required
                        class="w-full border p-2 rounded" />
                    <textarea name="about" placeholder="About You" class="w-full border p-2 rounded"></textarea>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">Save
                        Profile</button>
                </form>
            </div>

            <!-- User Posts -->
            <section id="postsContainer" class="space-y-6 pb-10">

                <h3 class="text-xl font-semibold text-gray-800">Posts</h3>
                <div id="postsList" class="space-y-4">
                    <!-- Posts will be appended here -->
                </div>
            </section>

        </section>

        <!-- Mobile Navigation -->
        <nav
            class="md:hidden fixed bottom-0 left-0 right-0 bg-white flex justify-around py-2 text-indigo-700 text-xl font-semibold z-50">
            <a href="home.html" class="flex flex-col items-center gap-0.5" aria-label="Home">
                <img src="Images/homebutton.png" alt="Home" class="h-7 w-7" />
            </a>

            <a href="add-message.html" class="flex flex-col items-center gap-0.5" aria-label="Post Message">
                <img src="Images/4-49677_add-button-with-plus-symbol-in-a-black.png" alt="Post" class="h-7 w-7" />
            </a>

            <a href="notifications.html" class="flex flex-col items-center gap-0.5" aria-label="Notifications">
                <img src="Images/notification-bell-black-11549537465xn5ekwdrj9.png" alt="Alerts" class="h-7 w-7" />
            </a>

            <a href="profile.html" class="flex flex-col items-center gap-0.5" aria-label="Profile">
                <img src="Images/c60ea00b55471c5a57ce5109dcd2f7df.png" alt="Profile" class="h-8 w-8" />
            </a>
        </nav>

    </main>

    <script type="module">
        import { db, auth } from './firebase-config.js';
        import {
            doc, getDoc, setDoc,
            collection, query, where, getDocs,
            deleteDoc, updateDoc
        } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
        const hamburgerBtn = document.getElementById('hamburgerBtn');
        const hamburgerMenu = document.getElementById('hamburgerMenu');
        const logoutBtn = document.getElementById('logoutBtn');

        // Toggle menu visibility
        hamburgerBtn.addEventListener('click', () => {
            const expanded = hamburgerBtn.getAttribute('aria-expanded') === 'true';
            hamburgerBtn.setAttribute('aria-expanded', !expanded);
            hamburgerMenu.classList.toggle('hidden');
        });

        // Close menu if clicking outside
        document.addEventListener('click', (e) => {
            if (!hamburgerMenu.contains(e.target) && e.target !== hamburgerBtn) {
                hamburgerMenu.classList.add('hidden');
                hamburgerBtn.setAttribute('aria-expanded', false);
            }
        });

        // Logout handler
        logoutBtn.addEventListener('click', async () => {
            try {
                await auth.signOut();
                window.location.href = 'index.html'; // redirect after logout
            } catch (error) {
                alert('Logout failed: ' + error.message);
            }
        });

        // Get UID from query param or return null
        function getQueryUid() {
            const params = new URLSearchParams(window.location.search);
            return params.get('uid');
        }

        // HTML escape helper
        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/[&<>"']/g, function (m) {
                switch (m) {
                    case '&': return '&amp;';
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '"': return '&quot;';
                    case "'": return '&#39;';
                    default: return m;
                }
            });
        }

        // Format timestamp to "time ago"
        function timeAgo(timestampMs) {
            if (!timestampMs) return "just now";
            const seconds = Math.floor((Date.now() - timestampMs) / 1000);
            if (seconds < 30) return "just now";
            const intervals = [
                { label: "year", seconds: 31536000 },
                { label: "month", seconds: 2592000 },
                { label: "day", seconds: 86400 },
                { label: "hour", seconds: 3600 },
                { label: "minute", seconds: 60 },
            ];
            for (const interval of intervals) {
                const count = Math.floor(seconds / interval.seconds);
                if (count > 0) return `${count} ${interval.label}${count !== 1 ? "s" : ""} ago`;
            }
            return "just now";
        }

        const profileContainer = document.getElementById('profileContainer');
        const formContainer = document.getElementById('formContainer');
        const profileForm = document.getElementById('profileForm');
        const editBtn = document.getElementById('editProfile');
        const postsList = document.getElementById('postsList');

        let currentUser = null;
        let viewingUid = null;
        let isOwnProfile = false;
        let userProfileData = null;
        postsList.innerHTML = `<div class="text-center text-gray-500 py-6">Loading Profile...</div>`;
        // Cache helpers
        function getProfileCacheKey(uid) {
            return `profileCache_${uid}`;
        }

        function cacheProfileData(uid, data) {
            const cacheObj = {
                timestamp: Date.now(),
                data
            };
            try {
                sessionStorage.setItem(getProfileCacheKey(uid), JSON.stringify(cacheObj));
            } catch {
                // ignore storage errors
            }
        }

        function getCachedProfileData(uid, maxAgeMs = 5 * 60 * 1000) { // 5 minutes cache expiry
            const cachedRaw = sessionStorage.getItem(getProfileCacheKey(uid));
            if (!cachedRaw) return null;
            try {
                const cached = JSON.parse(cachedRaw);
                if ((Date.now() - cached.timestamp) < maxAgeMs) {
                    return cached.data;
                }
            } catch {
                // invalid JSON or corrupted data
            }
            return null;
        }

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "index.html";
                return;
            }
            currentUser = user;

            const uidFromQuery = getQueryUid();
            if (!uidFromQuery || uidFromQuery === currentUser.uid) {
                viewingUid = currentUser.uid;
                isOwnProfile = true;
            } else {
                viewingUid = uidFromQuery;
                isOwnProfile = false;
            }

            await loadProfile();
            await loadUserPosts();
        });

        async function loadProfile() {
            try {
                // Try cached first for instant UI
                const cachedData = getCachedProfileData(viewingUid);
                if (cachedData) {
                    userProfileData = cachedData;
                    renderProfile(userProfileData);

                    if (isOwnProfile && !userProfileData.name) {
                        formContainer.classList.remove('hidden');
                        profileContainer.classList.add('hidden');
                        editBtn.style.display = 'none';
                    } else {
                        formContainer.classList.add('hidden');
                        profileContainer.classList.remove('hidden');
                        editBtn.style.display = isOwnProfile ? 'inline-block' : 'none';
                    }
                }

                // Fetch fresh data silently
                const docRef = doc(db, 'profiles', viewingUid);
                const profileSnap = await getDoc(docRef);
                if (profileSnap.exists()) {
                    const freshData = profileSnap.data();
                    if (JSON.stringify(freshData) !== JSON.stringify(userProfileData)) {
                        userProfileData = freshData;
                        cacheProfileData(viewingUid, freshData);
                        renderProfile(userProfileData);

                        if (isOwnProfile && !userProfileData.name) {
                            formContainer.classList.remove('hidden');
                            profileContainer.classList.add('hidden');
                            editBtn.style.display = 'none';
                        } else {
                            formContainer.classList.add('hidden');
                            profileContainer.classList.remove('hidden');
                            editBtn.style.display = isOwnProfile ? 'inline-block' : 'none';
                        }
                    }
                } else if (!cachedData) {
                    // No profile and no cache
                    if (isOwnProfile) {
                        formContainer.classList.remove('hidden');
                        profileContainer.classList.add('hidden');
                        editBtn.style.display = 'none';
                    } else {
                        profileContainer.innerHTML = '<p class="text-center text-gray-500">Profile not found.</p>';
                        profileContainer.classList.remove('hidden');
                        formContainer.classList.add('hidden');
                        editBtn.style.display = 'none';
                    }
                }
            } catch (err) {
                console.error("Error loading profile:", err);
                profileContainer.innerHTML = '<p class="text-center text-red-600">Failed to load profile.</p>';
            }
        }

        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isOwnProfile) return;

            const data = {
                name: profileForm.name.value.trim(),
                mobile: profileForm.mobile.value.trim(),
                email: currentUser.email,
                gender: profileForm.gender.value,
                age: profileForm.age.value,
                address: profileForm.address.value.trim(),
                about: profileForm.about.value.trim()
            };

            try {
                await setDoc(doc(db, 'profiles', currentUser.uid), data);
                userProfileData = data;
                cacheProfileData(currentUser.uid, data); // Update cache immediately
                renderProfile(data);
                formContainer.classList.add('hidden');
                profileContainer.classList.remove('hidden');
                editBtn.style.display = 'inline-block';
            } catch (err) {
                alert('Failed to save profile: ' + err.message);
                console.error(err);
            }
        });

        editBtn.addEventListener('click', async () => {
            if (!isOwnProfile) return;

            try {
                const docSnap = await getDoc(doc(db, 'profiles', currentUser.uid));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    profileForm.name.value = data.name || '';
                    profileForm.mobile.value = data.mobile || '';
                    profileForm.gender.value = data.gender || '';
                    profileForm.age.value = data.age || '';
                    profileForm.address.value = data.address || '';
                    profileForm.about.value = data.about || '';
                    formContainer.classList.remove('hidden');
                    profileContainer.classList.add('hidden');
                }
            } catch (err) {
                alert('Failed to load profile for editing: ' + err.message);
                console.error(err);
            }
        });

        // Load user posts for profile
        async function loadUserPosts() {
            postsList.innerHTML = `<div class="text-center text-gray-500 py-6">Loading posts...</div>`;

            try {
                const q = query(collection(db, 'messages'), where('uid', '==', viewingUid));
                const querySnap = await getDocs(q);

                if (querySnap.empty) {
                    postsList.innerHTML = '<p class="text-center text-gray-500 py-6">No posts found.</p>';
                    return;
                }

                postsList.innerHTML = '';
                const nowMs = Date.now();

                for (const docSnap of querySnap.docs) {
                    const postData = docSnap.data();
                    const postId = docSnap.id;

                    // Skip expired posts
                    if (postData.expiresAt?.seconds) {
                        const expiryMs = postData.expiresAt.seconds * 1000;
                        if (expiryMs < nowMs) continue;
                    }

                    renderPost(postId, postData);
                }
                if (postsList.children.length === 0) {
                    postsList.innerHTML = '<p class="text-center text-gray-500 py-6">No active posts found.</p>';
                }
            } catch (err) {
                console.error("Error loading posts:", err);
                postsList.innerHTML = '<p class="text-center text-red-600">Failed to load posts.</p>';
            }
        }


        function formatExpiry(timestampMs) {
            if (!timestampMs) return 'No expiry';
            const dt = new Date(timestampMs);
            return `Expires at ${dt.toLocaleString()}`;
        }

        function renderPost(postId, postData) {
            let expiryText = '';
            if (postData.expiresAt?.seconds) {
                const expiryTs = postData.expiresAt.seconds * 1000;
                expiryText = formatExpiry(expiryTs);
            } else {
                expiryText = 'No expiry';
            }

            const comments = postData.comments || [];

            const postDiv = document.createElement('div');
            postDiv.className = "bg-white p-4 rounded-xl shadow space-y-3 animate-fade";
            postDiv.setAttribute('data-post-id', postId);

            postDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <h4 class="text-lg font-semibold text-gray-900">${escapeHtml(postData.title)}</h4>
                    ${isOwnProfile ? `<button data-post-id="${postId}" aria-label="Delete post" title="Delete Post" class="delete-post-btn text-red-500 hover:text-red-700 transition">🗑️</button>` : ''}
                </div>
                <p class="text-gray-700">${escapeHtml(postData.description)}</p>

                <div class="text-xs text-gray-500 flex justify-between">
                    <div>${escapeHtml(postData.customLocation || "Unknown location")}</div>
                    <div>${expiryText}</div>
                </div>

                <div class="text-xs text-gray-500">${escapeHtml(postData.category || '')}</div>

                <!-- Comments Section -->
                <div class="mt-4">
                    <button aria-expanded="false" class="comment-toggle-btn text-indigo-600 text-sm font-semibold underline cursor-pointer">
                        💬 Comments (${comments.length})
                    </button>
                    <div class="comment-section hidden mt-2 space-y-2 max-h-48 overflow-auto border p-2 rounded bg-gray-50">
                        <div class="comments-list space-y-2 text-sm text-gray-800">
                            ${comments.length === 0 ? `<p class="italic text-gray-500">No comments yet.</p>` : comments.map((c, i) =>
                `<div class="flex justify-between items-start" data-comment-index="${i}">
                                    <div>
                                        <strong>${escapeHtml(c.name)}</strong>: ${escapeHtml(c.text)} <br />
                                        <span class="text-xs text-gray-500">${timeAgo(c.timestamp)}</span>
                                    </div>
                                    ${isOwnProfile ? `<button class="delete-comment-btn text-red-500 hover:text-red-700 ml-2" title="Delete Comment" aria-label="Delete comment" data-comment-index="${i}">✖️</button>` : ''}
                                </div>`).join('')}
                        </div>
                        <!-- Add comment disabled here as per your code -->
                    </div>
                </div>
            `;

            postsList.appendChild(postDiv);

            // Attach Post Delete handler
            if (isOwnProfile) {
                postDiv.querySelector('.delete-post-btn')?.addEventListener('click', async () => {
                    if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) return;
                    try {
                        await deleteDoc(doc(db, 'messages', postId));
                        postDiv.remove();
                    } catch (err) {
                        alert('Failed to delete post: ' + err.message);
                        console.error(err);
                    }
                });
            }

            // Attach comment toggle handler
            const commentToggleBtn = postDiv.querySelector('.comment-toggle-btn');
            const commentSection = postDiv.querySelector('.comment-section');
            commentToggleBtn.addEventListener('click', () => {
                const expanded = commentToggleBtn.getAttribute('aria-expanded') === 'true';
                commentToggleBtn.setAttribute('aria-expanded', expanded ? 'false' : 'true');
                commentSection.classList.toggle('hidden');
            });

            // Attach delete comment handlers (if own profile)
            if (isOwnProfile) {
                postDiv.querySelectorAll('.delete-comment-btn').forEach(btn => {
                    const commentIndex = parseInt(btn.getAttribute('data-comment-index'));
                    btn.addEventListener('click', async () => {
                        await deleteComment(postId, commentIndex, postDiv);
                    });
                });
            }
        }

        // Delete comment by index and update Firestore and UI
        async function deleteComment(postId, commentIndex, postDiv) {
            if (!confirm('Delete this comment? This action cannot be undone.')) return;

            try {
                const postRef = doc(db, 'messages', postId);
                const postSnap = await getDoc(postRef);
                if (!postSnap.exists()) {
                    alert('Post no longer exists');
                    return;
                }

                const comments = postSnap.data().comments || [];
                if (commentIndex < 0 || commentIndex >= comments.length) {
                    alert('Comment not found');
                    return;
                }

                const updatedComments = comments.filter((_, idx) => idx !== commentIndex);
                await updateDoc(postRef, { comments: updatedComments });

                const commentDiv = postDiv.querySelector(`.comments-list > div[data-comment-index="${commentIndex}"]`);
                if (commentDiv) commentDiv.remove();

                const commentToggleBtn = postDiv.querySelector('.comment-toggle-btn');
                const newCount = updatedComments.length;
                commentToggleBtn.textContent = `💬 Comments (${newCount})`;

                if (newCount === 0) {
                    const commentsList = postDiv.querySelector('.comments-list');
                    const noComMsg = document.createElement('p');
                    noComMsg.className = 'italic text-gray-500';
                    noComMsg.textContent = 'No comments yet.';
                    commentsList.appendChild(noComMsg);
                }

                refreshCommentIndexes(postDiv);
            } catch (err) {
                alert('Failed to delete comment: ' + err.message);
                console.error(err);
            }
        }

        // Refresh comment indexes & delete handlers after deletion
        function refreshCommentIndexes(postDiv) {
            const commentsList = postDiv.querySelector('.comments-list');
            const commentDivs = Array.from(commentsList.querySelectorAll('div[data-comment-index]'));
            commentDivs.forEach((div, i) => {
                div.setAttribute('data-comment-index', i);
                const delBtn = div.querySelector('.delete-comment-btn');
                if (delBtn) {
                    delBtn.setAttribute('data-comment-index', i);
                    const oldBtn = delBtn;
                    const newBtn = oldBtn.cloneNode(true);
                    oldBtn.parentNode.replaceChild(newBtn, oldBtn);
                    if (isOwnProfile) {
                        newBtn.addEventListener('click', async () => {
                            await deleteComment(postDiv.getAttribute('data-post-id'), i, postDiv);
                        });
                    }
                }
            });
        }

        // Render profile fields
        function renderProfile(data) {
            document.getElementById('name').textContent = data.name || '';
            document.getElementById('email').textContent = data.email || '';
            document.getElementById('mobile').textContent = data.mobile || '';
            document.getElementById('gender').textContent = data.gender || '';
            document.getElementById('age').textContent = data.age || '';
            document.getElementById('address').textContent = data.address || '';
            document.getElementById('about').textContent = data.about || '';
        }
    </script>

</body>

</html>