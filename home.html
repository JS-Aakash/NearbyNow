<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Home | NearbyNow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        fade: 'fadeIn 0.4s ease-in-out',
                    },
                    keyframes: {
                        fadeIn: {
                            from: { opacity: 0 },
                            to: { opacity: 1 },
                        },
                    },
                },
            },
        };
    </script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col md:flex-row">
    <!-- Sidebar -->
    <aside class="hidden md:flex md:flex-col bg-white w-50 p-6 shadow-lg space-y-6">
        <div class="flex items-center space-x-3">
            <img src="profile.png" class="w-11 h-11 rounded-full" alt="Profile" />
            <span class="text-lg font-bold">NearbyNow</span>
        </div>
        <nav class="space-y-5 text-base">
            <a href="home.html" class="flex items-center gap-2 hover:text-indigo-600 font-medium">Home</a>
            <a href="add-message.html" class="flex items-center gap-2 hover:text-indigo-600 font-medium">Add Post</a>
            <a href="notifications.html" class="flex items-center gap-2 hover:text-indigo-600 font-medium">
                Notifications</a>
            <a href="settings.html" class="flex items-center gap-2 hover:text-indigo-600 font-medium">Settings</a>
        </nav>
    </aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col">
        <!-- Mobile Header -->
        <header class="md:hidden bg-white p-4 flex justify-between items-center shadow">
            <img src="profile.png" class="w-9 h-9 rounded-full" alt="" />
            <h1 class="text-lg font-bold">NearbyNow</h1>
            <button onclick="location.href='settings.html'"
                class="text-gray-800 text-2xl p-2 rounded-full hover:bg-gray-200 transition duration-200"
                title="Settings">
                ‚öôÔ∏è
            </button>
        </header>

        <!-- Tabs -->
        <div class="bg-white flex justify-around text-sm font-semibold shadow">
            <button id="msgTab" class="tab-btn py-3 w-1/2 border-b-4 border-indigo-500 text-gray-900 transition">Nearby
                Messaging</button>
            <button id="foodTab" class="tab-btn py-3 w-1/2 border-b-4 border-transparent text-gray-600 transition">Food
                Share</button>
        </div>

        <!-- Filters -->
        <div id="filterBar"
            class="p-4 bg-white shadow flex flex-wrap gap-3 items-center justify-between text-sm sm:flex-nowrap">
            <select id="categoryFilter" class="border px-2 py-1 rounded hidden">
                <option value="All">Category: All</option>
                <option value="Community Msg">Community Msg</option>
                <option value="Emergency">Emergency</option>
                <option value="Request">Request</option>
                <option value="Service">Service</option>
            </select>

            <div class="flex items-center gap-1 ml-auto">
                <label for="distanceFilter"
                    class="text-sm font-medium whitespace-nowrap hidden sm:block">Distance:</label>
                <input type="range" id="distanceFilter" min="0.1" max="10" step="0.1" value="1" class="w-28 sm:w-32">
                <span id="distanceValue" class="text-sm font-medium whitespace-nowrap">1 km</span>
            </div>
        </div>

        <!-- Location Error -->
        <div id="locationRetry" class="hidden text-center p-4 bg-yellow-100 text-yellow-800">
            This app needs location access.
            <button onclick="requestLocation()" class="ml-2 px-3 py-1 bg-yellow-300 rounded">Try Again</button>
        </div>
        <!-- Loading Indicator -->
        <div id="loading" class="text-center text-gray-500 py-6 hidden">Loading...</div>

        <!-- Posts -->
        <section id="postFeed" class="p-4 space-y-4 overflow-auto flex-1 pb-24 animate-fade"></section>

        <!-- Mobile Nav -->
        <nav
            class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t shadow-inner flex justify-around py-2 text-indigo-700 text-xl font-semibold">

            <a href="home.html" class="flex flex-col items-center gap-0.5">
                <span class="text-2xl">üè†Ô∏é</span>
                <span class="text-sm">Home</span>
            </a>

            <a href="add-message.html" class="flex flex-col items-center gap-0.5">
                <span class="text-2xl">‚ûï</span>
                <span class="text-sm">Post Message</span>
            </a>

            <a href="notifications.html" class="flex flex-col items-center gap-0.5">
                <span class="text-2xl">‚úâÔ∏é</span>
                <span class="text-sm">Notifications</span>
            </a>

        </nav>

    </main>

    <!-- Firebase + Script -->
    <script type="module">
        import { db } from './firebase-config.js';
        import { collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        let currentTab = "Messaging";
        let userLat = null, userLon = null;

        const msgTabBtn = document.getElementById("msgTab");
        const foodTabBtn = document.getElementById("foodTab");
        const categoryFilter = document.getElementById("categoryFilter");
        const distanceSlider = document.getElementById("distanceFilter");
        const distanceValue = document.getElementById("distanceValue");
        const postFeed = document.getElementById("postFeed");

        msgTabBtn.addEventListener("click", () => {
            currentTab = "Messaging";
            updateTabs();
            fetchAndRender();
        });

        foodTabBtn.addEventListener("click", () => {
            currentTab = "Food Share";
            updateTabs();
            fetchAndRender();
        });

        categoryFilter.addEventListener("change", fetchAndRender);
        distanceSlider.addEventListener("input", () => {
            distanceValue.textContent = `${distanceSlider.value} km`;
            fetchAndRender();
        });

        function updateTabs() {
            msgTabBtn.classList.toggle("border-indigo-500", currentTab === "Messaging");
            msgTabBtn.classList.toggle("border-transparent", currentTab !== "Messaging");
            foodTabBtn.classList.toggle("border-indigo-500", currentTab === "Food Share");
            foodTabBtn.classList.toggle("border-transparent", currentTab !== "Food Share");

            if (currentTab === "Messaging") {
                categoryFilter.classList.remove("hidden");
                updateCategoryLabel();
            } else {
                categoryFilter.classList.add("hidden");
            }
        }

        function updateCategoryLabel() {
            [...categoryFilter.options].forEach(option => {
                if (option.value === "All") {
                    option.textContent = "Category: All";
                } else {
                    option.textContent = option.value;
                }
            });
        }

        function requestLocation() {
            const loadingEl = document.getElementById("loading");
            loadingEl.classList.remove("hidden");
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    userLat = pos.coords.latitude;
                    userLon = pos.coords.longitude;
                    document.getElementById("locationRetry").classList.add("hidden");
                    fetchAndRender();
                },
                () => {
                    loadingEl.classList.add("hidden");
                    document.getElementById("locationRetry").classList.remove("hidden");
                }
            );
        }


        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(lat1 * Math.PI / 180) *
                Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) ** 2;
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
        }

        function timeAgo(timestamp) {
            if (!timestamp) return "just now";
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 30) return "just now";
            const intervals = [
                { label: "year", seconds: 31536000 },
                { label: "month", seconds: 2592000 },
                { label: "day", seconds: 86400 },
                { label: "hour", seconds: 3600 },
                { label: "minute", seconds: 60 },
            ];
            for (const interval of intervals) {
                const count = Math.floor(seconds / interval.seconds);
                if (count > 0) return `${count} ${interval.label}${count !== 1 ? "s" : ""} ago`;
            }
            return "just now";
        }

        async function fetchAndRender() {
            const loadingEl = document.getElementById("loading");
            const postFeed = document.getElementById("postFeed");

            loadingEl.classList.remove("hidden");
            postFeed.innerHTML = "";

            if (userLat === null || userLon === null) {
                requestLocation();
                return;
            }

            updateTabs();
            const maxUserDistance = parseFloat(distanceSlider.value);
            const querySnap = await getDocs(collection(db, "messages"));

            const now = Date.now();
            const selectedCat = categoryFilter.value;
            let shown = 0;

            querySnap.forEach((doc) => {
                const data = doc.data();
                const expiry = Date.parse(data.expiresAt);
                if (isNaN(expiry) || now > expiry) return;

                const dist = getDistance(userLat, userLon, data.latitude, data.longitude);
                if (dist > (data.distance || 1) || dist > maxUserDistance) return;

                if (currentTab === "Messaging" && data.category === "Food Share") return;
                if (currentTab === "Food Share" && data.category !== "Food Share") return;
                if (currentTab === "Messaging" && selectedCat !== "All" && data.category !== selectedCat) return;

                const card = document.createElement("div");
                card.className = "bg-white p-4 rounded-xl shadow hover:shadow-md transition animate-fade";
                card.innerHTML = `
            <h2 class="text-lg font-semibold text-gray-900 mb-1">${data.title}</h2>
            <p class="text-gray-700 mb-2">${data.description}</p>
            <div class="text-sm text-gray-500 flex justify-between">
                <span>üìç ${data.customLocation || "Unknown location"}</span>
                <span>‚è±Ô∏è ${timeAgo(data.createdAt?.seconds * 1000)}</span>
            </div>
            <div class="text-xs text-indigo-500 mt-1">
                ${data.category} ‚Ä¢ ${dist.toFixed(2)} km away ‚Ä¢ 
                <a href="https://maps.google.com/?q=${data.latitude},${data.longitude}" target="_blank" class="underline">View Map</a>
            </div>
        `;
                postFeed.appendChild(card);
                shown++;
            });

            if (shown === 0) {
                postFeed.innerHTML = `<div class="text-center text-gray-500 mt-10">No posts found for selected filters.</div>`;
            }

            loadingEl.classList.add("hidden");
        }


        requestLocation();
    </script>
</body>

</html>