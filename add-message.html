<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="icon" href="Images/favicon.ico" type="image/x-icon">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add Message | NearbyNow</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- EmailJS SDK v4 (latest) loaded as normal script -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>

<body class="bg-gray-100 text-gray-800 flex flex-col md:flex-row min-h-screen">
    <!-- Sidebar for Desktop -->
    <aside class="hidden md:flex md:flex-col bg-white w-50 p-6 shadow-lg space-y-6">
        <div class="flex items-center space-x-3">
            <img src="Images/profile.png" class="w-11 h-11 rounded-full" alt="Profile" />
            <span class="text-lg font-bold">NearbyNow</span>
        </div>
        <nav class="space-y-5 text-base">
            <a href="home.html" class="flex items-center gap-2 hover:text-indigo-600 font-medium">Home</a>
            <a href="add-message.html" class="flex items-center gap-2 hover:text-indigo-600 font-medium">Add Post</a>
            <a href="notifications.html"
                class="flex items-center gap-2 hover:text-indigo-600 font-medium">Notifications</a>
            <a href="profile.html" class="flex items-center gap-2 hover:text-indigo-600 font-medium">Profile</a>
            <a href="settings.html" class="flex items-center gap-2 hover:text-indigo-600 font-medium">Settings</a>
            <a href="index.html" class="flex items-center gap-2 hover:text-indigo-600 font-medium">Logout</a>
        </nav>
    </aside>

    <!-- Header for Mobile -->
    <header class="md:hidden bg-white p-4 flex justify-between items-center shadow relative">
        <img src="Images/profile.png" alt="" class="w-9 h-9 rounded-full" />
        <h1 class="text-lg font-bold">NearbyNow</h1>

        <!-- Hamburger button -->
        <button id="hamburgerBtn" aria-label="Menu" aria-expanded="false"
            class="text-gray-800 text-3xl p-2 rounded-full hover:bg-gray-200 transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            &#9776;
        </button>

        <!-- Dropdown menu (hidden by default) -->
        <div id="hamburgerMenu"
            class="hidden absolute top-full right-4 mt-2 w-36 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
            <a href="settings.html"
                class="block px-4 py-2 text-gray-700 hover:bg-indigo-600 hover:text-white rounded-t-lg">Settings</a>
            <button id="logoutBtn"
                class="w-full text-left px-4 py-2 text-gray-700 hover:bg-indigo-600 hover:text-white rounded-b-lg">Logout</button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 px-4 py-6 md:py-10">
        <div class="max-w-2xl mx-auto bg-white p-6 rounded-xl shadow-md">
            <form id="messageForm" class="space-y-4">
                <input type="text" id="title" placeholder="Title" required class="w-full p-3 border rounded" />
                <textarea id="description" rows="4" placeholder="Description" required
                    class="w-full p-3 border rounded"></textarea>
                <input type="text" id="customLocation" placeholder="Custom Location"
                    class="w-full p-3 border rounded" />

                <div>
                    <label for="distance" class="block text-sm font-medium text-gray-700 mb-1">Visible Distance
                        (km)</label>
                    <input type="number" id="distance" min="0.1" max="20" step="0.1" value="1"
                        class="w-full p-3 border rounded" required />
                </div>

                <div>
                    <label for="expiry" class="block text-sm font-medium text-gray-700 mb-1">Message Expiry
                        (hours)</label>
                    <input type="number" id="expiry" min="1" max="24" value="1" class="w-full p-3 border rounded"
                        required />
                </div>

                <select id="category" required class="w-full p-3 border rounded">
                    <option value="">Select Category</option>
                    <option value="Community Msg">Community Msg</option>
                    <option value="Food Share">Food Share</option>
                    <option value="Emergency">Emergency</option>
                    <option value="Request">Request</option>
                    <option value="Service">Service</option>
                </select>

                <div>
                    <label for="scheduleTime" class="block text-sm font-medium text-gray-700 mb-1">Schedule Post
                        (optional)</label>
                    <input type="datetime-local" id="scheduleTime" class="w-full p-3 border rounded" min="" />
                    <p class="text-xs text-gray-500 mt-1">Leave empty to post immediately</p>
                </div>

                <!-- Added Image Input -->
                <div>
                    <label for="postImage" class="block text-sm font-medium text-gray-700 mb-1">Post Image
                        (optional)</label>
                    <input type="file" id="postImage" accept="image/*" class="w-full p-3 border rounded" />
                </div>

                <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700">
                    Post Message
                </button>
            </form>

            <p id="posting" class="text-center mt-4 text-blue-600 font-medium hidden"><span class="animate-pulse">ðŸ“¤
                    Posting message...</span></p>
            <p id="status" class="text-center mt-2 text-green-600 font-medium hidden">Message posted!</p>
            <p id="error" class="text-center mt-2 text-red-600 font-medium hidden">Failed to post. Try again.</p>
        </div>
    </main>

    <!-- Bottom Navigation (Mobile) -->
    <nav
        class="md:hidden fixed bottom-0 left-0 right-0 bg-white flex justify-around py-2 text-indigo-700 text-xl font-semibold z-50">
        <a href="home.html" class="flex flex-col items-center gap-0.5" aria-label="Home">
            <img src="Images/homebutton.png" alt="Home" class="h-7 w-7" />
        </a>

        <a href="add-message.html" class="flex flex-col items-center gap-0.5" aria-label="Post Message">
            <img src="Images/4-49677_add-button-with-plus-symbol-in-a-black.png" alt="Post" class="h-7 w-7" />
        </a>

        <a href="notifications.html" class="flex flex-col items-center gap-0.5" aria-label="Notifications">
            <img src="Images/notification-bell-black-11549537465xn5ekwdrj9.png" alt="Alerts" class="h-7 w-7" />
        </a>

        <a href="profile.html" class="flex flex-col items-center gap-0.5" aria-label="Profile">
            <img src="Images/c60ea00b55471c5a57ce5109dcd2f7df.png" alt="Profile" class="h-8 w-8" />
        </a>
    </nav>

    <!-- Firebase & JS -->
    <script type="module">
        import { db, auth } from './firebase-config.js';
        import {
            collection,
            addDoc,
            serverTimestamp,
            Timestamp,
            doc,
            getDoc,
            getDocs
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        emailjs.init("F8YJAVO_mmfS3h3Gz");

        const EMAILJS_SERVICE_ID = "service_ywz50ea";
        const EMAILJS_TEMPLATE_ID = "template_ggzqzcl";

        const form = document.getElementById('messageForm');
        const postImage = document.getElementById('postImage');
        const status = document.getElementById('status');
        const posting = document.getElementById('posting');
        const error = document.getElementById('error');
        const scheduleInput = document.getElementById('scheduleTime');

        let currentUser = null;
        let userName = null;
        let cachedLocation = null;
        const hamburgerBtn = document.getElementById('hamburgerBtn');
        const hamburgerMenu = document.getElementById('hamburgerMenu');
        const logoutBtn = document.getElementById('logoutBtn');

        hamburgerBtn.addEventListener('click', () => {
            const expanded = hamburgerBtn.getAttribute('aria-expanded') === 'true';
            hamburgerBtn.setAttribute('aria-expanded', !expanded);
            hamburgerMenu.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!hamburgerMenu.contains(e.target) && e.target !== hamburgerBtn) {
                hamburgerMenu.classList.add('hidden');
                hamburgerBtn.setAttribute('aria-expanded', false);
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await auth.signOut();
                window.location.href = 'index.html';
            } catch (error) {
                alert('Logout failed: ' + error.message);
            }
        });

        function setMinScheduleTime() {
            const now = new Date();
            const formatted = now.toISOString().slice(0, 16);
            if (scheduleInput) scheduleInput.min = formatted;
        }
        setMinScheduleTime();

        function loadCachedLocation() {
            const lat = sessionStorage.getItem('userLat');
            const lon = sessionStorage.getItem('userLon');
            if (lat && lon) {
                cachedLocation = {
                    latitude: parseFloat(lat),
                    longitude: parseFloat(lon)
                };
                return true;
            }
            return false;
        }

        function requestLocationOnce() {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        cachedLocation = pos.coords;
                        sessionStorage.setItem('userLat', cachedLocation.latitude);
                        sessionStorage.setItem('userLon', cachedLocation.longitude);
                        resolve();
                    },
                    (err) => {
                        reject("Location permission is required to post messages.");
                    }
                );
            });
        }

        async function fetchUserName(uid) {
            try {
                const profileDocRef = doc(db, 'profiles', uid);
                const profileDocSnap = await getDoc(profileDocRef);
                if (profileDocSnap.exists()) {
                    return profileDocSnap.data().name || "Anonymous";
                } else {
                    return "Anonymous";
                }
            } catch (err) {
                console.error("Error fetching user profile name:", err);
                return "Anonymous";
            }
        }

        async function sendEmailToAll(name, title, description, category, messageCoords, maxDistanceKm, customLocationStr) {
            try {
                const profilesSnapshot = await getDocs(collection(db, 'profiles'));
                const emailPromises = [];
                profilesSnapshot.forEach(profileDoc => {
                    const profileData = profileDoc.data();
                    const recipientEmail = profileData.email;
                    const profileUid = profileDoc.id;
                    if (profileUid === currentUser.uid) return;
                    if (recipientEmail && profileData.latitude !== undefined && profileData.longitude !== undefined) {
                        const dist = getDistance(
                            messageCoords.latitude,
                            messageCoords.longitude,
                            profileData.latitude,
                            profileData.longitude
                        );
                        if (dist <= maxDistanceKm) {
                            const templateParams = {
                                to_email: recipientEmail,
                                name: name,
                                email: recipientEmail,
                                message_title: title,
                                message_description: description,
                                Category: category
                            };
                            emailPromises.push(
                                emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams)
                                    .catch(err => {
                                        console.error("Failed to send email to", recipientEmail, err);
                                    })
                            );
                        }
                    }
                });
                await Promise.all(emailPromises);
                console.log("Emails sent successfully to all in range except sender.");
            } catch (err) {
                console.error("Error sending emails:", err);
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "index.html";
                return;
            }
            currentUser = user;
            userName = await fetchUserName(currentUser.uid);
            if (!loadCachedLocation()) {
                try {
                    await requestLocationOnce();
                } catch (errMsg) {
                    alert(errMsg);
                }
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            error.classList.add("hidden");
            status.classList.add("hidden");

            // Show loading instantly before any async operation
            posting.classList.remove("hidden");

            const title = form.title.value.trim();
            const description = form.description.value.trim();
            const customLocation = form.customLocation.value.trim();
            const distance = parseFloat(form.distance.value);
            const expiry = parseInt(form.expiry.value);
            const category = form.category.value;
            const scheduleTimeVal = scheduleInput ? scheduleInput.value : null;

            if (!title || !description || !category) {
                posting.classList.add("hidden");
                alert("Please fill in all required fields.");
                return;
            }

            if (distance > 20 || expiry > 24 || distance < 0.1 || expiry < 1) {
                posting.classList.add("hidden");
                alert("Max distance is 20km and max expiry time is 24 hours.");
                return;
            }

            if (!cachedLocation) {
                posting.classList.add("hidden");
                alert("Getting your location. Please wait and try again.");
                try {
                    await requestLocationOnce();
                } catch (errMsg) {
                    alert(errMsg);
                }
                return;
            }

            let scheduledAt = null;
            if (scheduleTimeVal) {
                const dt = new Date(scheduleTimeVal);
                if (dt.getTime() < Date.now()) {
                    posting.classList.add("hidden");
                    alert("Scheduled time cannot be in the past.");
                    return;
                }
                scheduledAt = Timestamp.fromDate(dt);
            } else {
                scheduledAt = Timestamp.fromDate(new Date());
            }

            // OPTIONAL IMAGE UPLOAD HANDLING
            let imageUrl = "";
            if (postImage.files[0]) {
                try {
                    const storage = getStorage();
                    const imageFile = postImage.files[0];
                    const storageRef = ref(storage, `postImages/${currentUser.uid}_${Date.now()}_${imageFile.name}`);
                    await uploadBytes(storageRef, imageFile);
                    imageUrl = await getDownloadURL(storageRef);
                } catch (uploadError) {
                    posting.classList.add("hidden");
                    alert("Image upload failed. Please try again.");
                    return;
                }
            }

            try {
                await addDoc(collection(db, "messages"), {
                    uid: currentUser.uid,
                    authorName: userName,
                    title,
                    description,
                    customLocation,
                    latitude: cachedLocation.latitude,
                    longitude: cachedLocation.longitude,
                    category,
                    distance,
                    likes: [],
                    comments: [],
                    createdAt: serverTimestamp(),
                    expiresAt: Timestamp.fromDate(new Date(scheduledAt.toDate().getTime() + expiry * 3600 * 1000)),
                    scheduledAt,
                    imageUrl // save image URL if uploaded
                });

                if (!scheduleTimeVal) {
                    await sendEmailToAll(userName, title, description, category, cachedLocation, distance, customLocation);
                }

                form.reset();
                status.classList.remove("hidden");
                setMinScheduleTime();

                setTimeout(() => status.classList.add("hidden"), 3000);
            } catch (err) {
                error.classList.remove("hidden");
                setTimeout(() => error.classList.add("hidden"), 4000);
                console.error("Error posting message:", err);
            } finally {
                posting.classList.add("hidden");
            }
        });

    </script>
</body>

</html>