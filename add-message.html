<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="icon" href="Images/favicon.ico" type="image/x-icon">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add Message | NearbyNow</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- EmailJS SDK v4 (latest) loaded as normal script -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>

<body class="bg-gray-100 text-gray-800 flex flex-col md:flex-row min-h-screen">

    <!-- Sidebar for Desktop -->
    <aside class="hidden md:flex md:flex-col bg-white w-50 p-6 shadow-lg space-y-6">
        <div class="flex items-center space-x-3">
            <img src="Images/profile.png" class="w-11 h-11 rounded-full" alt="Profile" />
            <span class="text-lg font-bold">NearbyNow</span>
        </div>
        <nav class="space-y-5 text-base">
            <a href="home.html" class="flex items-center gap-2 hover:text-indigo-600 font-medium">Home</a>
            <a href="add-message.html" class="flex items-center gap-2 hover:text-indigo-600 font-medium">Add Post</a>
            <a href="notifications.html"
                class="flex items-center gap-2 hover:text-indigo-600 font-medium">Notifications</a>
            <a href="profile.html" class="flex items-center gap-2 hover:text-indigo-600 font-medium">Profile</a>
            <a href="settings.html" class="flex items-center gap-2 hover:text-indigo-600 font-medium">Settings</a>
            <a href="index.html" class="flex items-center gap-2 hover:text-indigo-600 font-medium">Logout</a>
        </nav>
    </aside>

    <!-- Header for Mobile -->
    <header class="md:hidden bg-white p-4 flex justify-between items-center shadow relative">
        <img src="Images/profile.png" alt="" class="w-9 h-9 rounded-full" />
        <h1 class="text-lg font-bold">NearbyNow</h1>

        <!-- Hamburger button -->
        <button id="hamburgerBtn" aria-label="Menu" aria-expanded="false"
            class="text-gray-800 text-3xl p-2 rounded-full hover:bg-gray-200 transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            &#9776; <!-- hamburger icon -->
        </button>

        <!-- Dropdown menu (hidden by default) -->
        <div id="hamburgerMenu"
            class="hidden absolute top-full right-4 mt-2 w-36 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
            <a href="settings.html"
                class="block px-4 py-2 text-gray-700 hover:bg-indigo-600 hover:text-white rounded-t-lg">Settings</a>
            <button id="logoutBtn"
                class="w-full text-left px-4 py-2 text-gray-700 hover:bg-indigo-600 hover:text-white rounded-b-lg">Logout</button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 px-4 py-6 md:py-10">
        <div class="max-w-2xl mx-auto bg-white p-6 rounded-xl shadow-md">
            <form id="messageForm" class="space-y-4">
                <input type="text" id="title" placeholder="Title" required class="w-full p-3 border rounded" />
                <textarea id="description" rows="4" placeholder="Description" required
                    class="w-full p-3 border rounded"></textarea>
                <input type="text" id="customLocation" placeholder="Custom Location"
                    class="w-full p-3 border rounded" />

                <div>
                    <label for="distance" class="block text-sm font-medium text-gray-700 mb-1">Visible Distance
                        (km)</label>
                    <input type="number" id="distance" min="0.1" max="20" step="0.1" value="1"
                        class="w-full p-3 border rounded" required />
                </div>

                <div>
                    <label for="expiry" class="block text-sm font-medium text-gray-700 mb-1">Message Expiry
                        (hours)</label>
                    <input type="number" id="expiry" min="1" max="24" value="1" class="w-full p-3 border rounded"
                        required />
                </div>

                <select id="category" required class="w-full p-3 border rounded">
                    <option value="">Select Category</option>
                    <option value="Community Msg">Community Msg</option>
                    <option value="Food Share">Food Share</option>
                    <option value="Emergency">Emergency</option>
                    <option value="Request">Request</option>
                    <option value="Service">Service</option>
                </select>
                <div>
                    <label for="scheduleTime" class="block text-sm font-medium text-gray-700 mb-1">
                        Schedule Post (optional)
                    </label>
                    <input type="datetime-local" id="scheduleTime" class="w-full p-3 border rounded" min="" />
                    <p class="text-xs text-gray-500 mt-1">Leave empty to post immediately</p>
                </div>

                <!-- Image Upload Section -->
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">Add Image (Optional)</label>
                    <div class="flex items-center justify-center w-full">
                        <label for="imageInput"
                            class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition">
                            <div id="uploadPlaceholder" class="flex flex-col items-center justify-center pt-5 pb-6">
                                <svg class="w-8 h-8 mb-3 text-gray-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                                    </path>
                                </svg>
                                <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload</span>
                                    or drag and drop</p>
                                <p class="text-xs text-gray-400">PNG, JPG or JPEG (MAX. 5MB)</p>
                            </div>
                            <img id="imagePreview" class="hidden h-full w-full object-contain p-2 rounded-lg"
                                alt="Preview" />
                            <input id="imageInput" type="file" class="hidden" accept="image/*" />
                        </label>
                    </div>
                    <button type="button" id="removeImageBtn"
                        class="hidden text-red-500 text-xs font-medium hover:underline">Remove Image</button>
                </div>

                <button type="submit" id="submitBtn"
                    class="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors">Post
                    Message</button>
            </form>

            <p id="posting" class="text-center mt-4 text-blue-600 font-medium hidden"><span class="animate-pulse">üì§
                    Posting message...</span></p>
            <p id="status" class="text-center mt-2 text-green-600 font-medium hidden">Message posted!</p>
            <p id="error" class="text-center mt-2 text-red-600 font-medium hidden">Failed to post. Try again.</p>
        </div>
    </main>

    <!-- Bottom Navigation (Mobile) -->
    <nav
        class="md:hidden fixed bottom-0 left-0 right-0 bg-white flex justify-around py-2 text-indigo-700 text-xl font-semibold z-50">
        <a href="home.html" class="flex flex-col items-center gap-0.5" aria-label="Home">
            <img src="Images/homebutton.png" alt="Home" class="h-7 w-7" />
        </a>

        <a href="add-message.html" class="flex flex-col items-center gap-0.5" aria-label="Post Message">
            <img src="Images/4-49677_add-button-with-plus-symbol-in-a-black.png" alt="Post" class="h-7 w-7" />
        </a>

        <a href="notifications.html" class="flex flex-col items-center gap-0.5" aria-label="Notifications">
            <img src="Images/notification-bell-black-11549537465xn5ekwdrj9.png" alt="Alerts" class="h-7 w-7" />
        </a>

        <a href="profile.html" class="flex flex-col items-center gap-0.5" aria-label="Profile">
            <img src="Images/c60ea00b55471c5a57ce5109dcd2f7df.png" alt="Profile" class="h-8 w-8" />
        </a>

    </nav>

    <script type="module">
        import { db, auth, envConfig } from './firebase-config.js';
        import {
            collection,
            addDoc,
            serverTimestamp,
            Timestamp,
            doc,
            getDoc,
            getDocs
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        // Initialize EmailJS from envConfig
        emailjs.init(envConfig.EMAILJS.PUBLIC_KEY);

        const EMAILJS_SERVICE_ID = envConfig.EMAILJS.SERVICE_ID;
        const EMAILJS_TEMPLATE_ID = envConfig.EMAILJS.TEMPLATE_ID;

        const form = document.getElementById('messageForm');
        const status = document.getElementById('status');
        const posting = document.getElementById('posting');
        const error = document.getElementById('error');
        const scheduleInput = document.getElementById('scheduleTime');
        const imageInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');
        const removeImageBtn = document.getElementById('removeImageBtn');
        const submitBtn = document.getElementById('submitBtn');

        // Pinata Configuration from envConfig
        const PINATA_JWT = envConfig.PINATA.JWT;
        const PINATA_GATEWAY = envConfig.PINATA.GATEWAY;

        let currentUser = null;
        let userName = null; // Will hold name fetched from profiles collection
        let cachedLocation = null;
        const hamburgerBtn = document.getElementById('hamburgerBtn');
        const hamburgerMenu = document.getElementById('hamburgerMenu');
        const logoutBtn = document.getElementById('logoutBtn');

        // Toggle menu visibility
        hamburgerBtn.addEventListener('click', () => {
            const expanded = hamburgerBtn.getAttribute('aria-expanded') === 'true';
            hamburgerBtn.setAttribute('aria-expanded', !expanded);
            hamburgerMenu.classList.toggle('hidden');
        });

        // Close menu if clicking outside
        document.addEventListener('click', (e) => {
            if (!hamburgerMenu.contains(e.target) && e.target !== hamburgerBtn) {
                hamburgerMenu.classList.add('hidden');
                hamburgerBtn.setAttribute('aria-expanded', false);
            }
        });

        // Logout handler
        logoutBtn.addEventListener('click', async () => {
            try {
                await auth.signOut();
                window.location.href = 'index.html'; // redirect after logout
            } catch (error) {
                alert('Logout failed: ' + error.message);
            }
        });

        // Set the minimum scheduling time to current datetime to prevent past dates
        function setMinScheduleTime() {
            const now = new Date();
            const formatted = now.toISOString().slice(0, 16); // Format: "YYYY-MM-DDTHH:MM"
            if (scheduleInput) scheduleInput.min = formatted;
        }
        setMinScheduleTime();

        // Load location from sessionStorage
        function loadCachedLocation() {
            const lat = sessionStorage.getItem('userLat');
            const lon = sessionStorage.getItem('userLon');
            if (lat && lon) {
                cachedLocation = {
                    latitude: parseFloat(lat),
                    longitude: parseFloat(lon)
                };
                return true;
            }
            return false;
        }

        // Request location once and cache it
        function requestLocationOnce() {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        cachedLocation = pos.coords;
                        sessionStorage.setItem('userLat', cachedLocation.latitude);
                        sessionStorage.setItem('userLon', cachedLocation.longitude);
                        resolve();
                    },
                    (err) => {
                        reject("Location permission is required to post messages.");
                    }
                );
            });
        }

        // Calculate distance between two lat/lon points in km using Haversine formula
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of Earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        // Fetch the user name from profiles collection by UID
        async function fetchUserName(uid) {
            try {
                const profileDocRef = doc(db, 'profiles', uid);
                const profileDocSnap = await getDoc(profileDocRef);
                if (profileDocSnap.exists()) {
                    return profileDocSnap.data().name || "Anonymous";
                } else {
                    return "Anonymous";
                }
            } catch (err) {
                console.error("Error fetching user profile name:", err);
                return "Anonymous";
            }
        }

        // Send email only to users within distance
        async function sendEmailToAll(name, title, description, category, messageCoords, maxDistanceKm, customLocationStr) {
            try {
                const profilesSnapshot = await getDocs(collection(db, 'profiles'));
                const emailPromises = [];

                profilesSnapshot.forEach(profileDoc => {
                    const profileData = profileDoc.data();
                    const recipientEmail = profileData.email;
                    const profileUid = profileDoc.id;

                    // Skip sender
                    if (profileUid === currentUser.uid) return;

                    // Ensure valid coordinates to calculate distance
                    if (recipientEmail && profileData.latitude !== undefined && profileData.longitude !== undefined) {
                        const dist = getDistance(
                            messageCoords.latitude,
                            messageCoords.longitude,
                            profileData.latitude,
                            profileData.longitude
                        );

                        if (dist <= maxDistanceKm) {
                            const templateParams = {
                                to_email: recipientEmail,
                                name: name,
                                email: recipientEmail,
                                message_title: title,
                                message_description: description,
                                Category: category
                            };

                            emailPromises.push(
                                emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams)
                                    .catch(err => {
                                        console.error("Failed to send email to", recipientEmail, err);
                                    })
                            );
                        }
                    }
                });

                await Promise.all(emailPromises);
                console.log("Emails sent successfully to all in range except sender.");
            } catch (err) {
                console.error("Error sending emails:", err);
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "index.html";
                return;
            }
            currentUser = user;

            // Fetch the user name after login
            userName = await fetchUserName(currentUser.uid);

            if (!loadCachedLocation()) {
                try {
                    await requestLocationOnce();
                } catch (errMsg) {
                    alert(errMsg);
                }
            }
        });

        // Image selection and preview
        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    alert("Image size should be less than 5MB");
                    imageInput.value = "";
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                    uploadPlaceholder.classList.add('hidden');
                    removeImageBtn.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        removeImageBtn.addEventListener('click', () => {
            imageInput.value = "";
            imagePreview.src = "";
            imagePreview.classList.add('hidden');
            uploadPlaceholder.classList.remove('hidden');
            removeImageBtn.classList.add('hidden');
        });

        async function uploadToPinata(file) {
            const formData = new FormData();
            formData.append('file', file);

            const metadata = JSON.stringify({
                name: `NearbyNow_${Date.now()}_${file.name}`,
            });
            formData.append('pinataMetadata', metadata);

            const options = JSON.stringify({
                cidVersion: 0,
            });
            formData.append('pinataOptions', options);

            const response = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${PINATA_JWT}`
                },
                body: formData
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'Failed to upload image to Pinata');
            }

            const data = await response.json();
            return data.IpfsHash;
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            error.classList.add("hidden");
            status.classList.add("hidden");

            const title = form.title.value.trim();
            const description = form.description.value.trim();
            const customLocation = form.customLocation.value.trim();
            const distance = parseFloat(form.distance.value);
            const expiry = parseInt(form.expiry.value);
            const category = form.category.value;
            const scheduleTimeVal = scheduleInput ? scheduleInput.value : null;

            if (!title || !description || !category) {
                alert("Please fill in all required fields.");
                return;
            }
            if (distance > 20 || expiry > 24 || distance < 0.1 || expiry < 1) {
                alert("Max distance is 20km and max expiry time is 24 hours.");
                return;
            }
            if (!cachedLocation) {
                alert("Getting your location. Please wait and try again.");
                try {
                    await requestLocationOnce();
                } catch (errMsg) {
                    alert(errMsg);
                }
                return;
            }

            // Parse schedule time or fallback to immediate publish
            let scheduledAt = null;
            if (scheduleTimeVal) {
                const dt = new Date(scheduleTimeVal);
                if (dt.getTime() < Date.now()) {
                    alert("Scheduled time cannot be in the past.");
                    return;
                }
                scheduledAt = Timestamp.fromDate(dt);
            } else {
                scheduledAt = Timestamp.fromDate(new Date());
            }

            try {
                posting.classList.remove("hidden");
                submitBtn.disabled = true;

                let imageUrl = null;
                if (imageInput.files[0]) {
                    if (!PINATA_JWT || PINATA_JWT === "YOUR_PINATA_JWT_HERE") {
                        alert("Pinata JWT is not configured in env.json. Please add your JWT there.");
                        throw new Error("Pinata JWT missing");
                    }
                    posting.innerHTML = '<span class="animate-pulse">üñºÔ∏è Uploading image to IPFS...</span>';
                    const ipfsHash = await uploadToPinata(imageInput.files[0]);
                    imageUrl = PINATA_GATEWAY + ipfsHash;
                }

                posting.innerHTML = '<span class="animate-pulse">üì§ Posting message...</span>';

                await addDoc(collection(db, "messages"), {
                    uid: currentUser.uid,
                    authorName: userName,
                    title,
                    description,
                    customLocation,
                    latitude: cachedLocation.latitude,
                    longitude: cachedLocation.longitude,
                    category,
                    distance,
                    imageUrl, // Store the IPFS URL
                    likes: [],
                    comments: [],
                    createdAt: serverTimestamp(),
                    expiresAt: Timestamp.fromDate(new Date(scheduledAt.toDate().getTime() + expiry * 3600 * 1000)),
                    scheduledAt  // save scheduled timestamp or current time
                });

                // Send emails only for immediate posts (optional: skip scheduling emails)
                if (!scheduleTimeVal) {
                    await sendEmailToAll(userName, title, description, category, cachedLocation, distance, customLocation);
                }

                form.reset();
                imagePreview.src = "";
                imagePreview.classList.add('hidden');
                uploadPlaceholder.classList.remove('hidden');
                removeImageBtn.classList.add('hidden');

                posting.classList.add("hidden");
                status.classList.remove("hidden");
                setMinScheduleTime();

                setTimeout(() => status.classList.add("hidden"), 3000);
            } catch (err) {
                posting.classList.add("hidden");
                error.classList.remove("hidden");
                setTimeout(() => error.classList.add("hidden"), 4000);
                console.error("Error posting message:", err);
            } finally {
                submitBtn.disabled = false;
                posting.innerHTML = '<span class="animate-pulse">üì§ Posting message...</span>';
            }
        });
    </script>


</body>

</html>