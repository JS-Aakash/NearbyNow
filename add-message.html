<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add Message | NearbyNow</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 text-gray-800 flex flex-col md:flex-row min-h-screen">

    <!-- Sidebar for Desktop -->
    <aside class="hidden md:flex md:flex-col bg-white w-50 p-6 shadow-lg space-y-6">
        <div class="flex items-center space-x-3">
            <img src="Images/profile.png" class="w-11 h-11 rounded-full" alt="Profile" />
            <span class="text-lg font-bold">NearbyNow</span>
        </div>
        <nav class="space-y-5 text-base">
            <a href="home.html" class="flex items-center gap-2 hover:text-indigo-600 font-medium">Home</a>
            <a href="add-message.html" class="flex items-center gap-2 hover:text-indigo-600 font-medium">Add Post</a>
            <a href="notifications.html" class="flex items-center gap-2 hover:text-indigo-600 font-medium">
                Notifications</a>
            <a href="profile.html" class="flex items-center gap-2 hover:text-indigo-600 font-medium">Profile</a>
            <a href="settings.html" class="flex items-center gap-2 hover:text-indigo-600 font-medium">Settings</a>
            <a href="index.html" class="flex items-center gap-2 hover:text-indigo-600 font-medium">Logout</a>
        </nav>
    </aside>

    <!-- Header for Mobile -->
    <header class="md:hidden bg-white p-4 flex justify-between items-center shadow">
        <img src="Images/profile.png" class="w-9 h-9 rounded-full" alt="" />
        <h1 class="text-lg font-bold">NearbyNow</h1>
        <button onclick="location.href='settings.html'"
            class="text-gray-800 text-2xl p-2 rounded-full hover:bg-gray-200 transition duration-200" title="Settings">
            ‚öôÔ∏è
        </button>
    </header>

    <!-- Main Content -->
    <main class="flex-1 px-4 py-6 md:py-10">
        <div class="max-w-2xl mx-auto bg-white p-6 rounded-xl shadow-md">
            <form id="messageForm" class="space-y-4">
                <input type="text" id="title" placeholder="Title" required class="w-full p-3 border rounded" />
                <textarea id="description" rows="4" placeholder="Description" required
                    class="w-full p-3 border rounded"></textarea>
                <input type="text" id="customLocation" placeholder="Custom Location (optional)"
                    class="w-full p-3 border rounded" />

                <div>
                    <label for="distance" class="block text-sm font-medium text-gray-700 mb-1">Visible Distance
                        (km)</label>
                    <input type="number" id="distance" min="0.1" max="20" step="0.1" value="1"
                        class="w-full p-3 border rounded" required />
                </div>

                <div>
                    <label for="expiry" class="block text-sm font-medium text-gray-700 mb-1">Message Expiry
                        (hours)</label>
                    <input type="number" id="expiry" min="1" max="24" value="1" class="w-full p-3 border rounded"
                        required />
                </div>

                <select id="category" required class="w-full p-3 border rounded">
                    <option value="">Select Category</option>
                    <option value="Community Msg">Community Msg</option>
                    <option value="Food Share">Food Share</option>
                    <option value="Emergency">Emergency</option>
                    <option value="Request">Request</option>
                    <option value="Service">Service</option>
                </select>

                <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700">Post
                    Message</button>
            </form>

            <p id="posting" class="text-center mt-4 text-blue-600 font-medium hidden">
                <span class="animate-pulse">üì§ Posting message...</span>
            </p>
            <p id="status" class="text-center mt-2 text-green-600 font-medium hidden">Message posted!</p>
            <p id="error" class="text-center mt-2 text-red-600 font-medium hidden">Failed to post. Try again.</p>

        </div>
    </main>

    <!-- Bottom Navigation (Mobile) -->
    <nav
        class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t shadow-inner flex justify-around py-2 text-indigo-700 text-xl font-semibold">

        <a href="home.html" class="flex flex-col items-center gap-0.5" aria-label="Home">
            <span class="text-2xl select-none">üè†Ô∏é</span>
            <span class="text-sm">Home</span>
        </a>

        <a href="add-message.html" class="flex flex-col items-center gap-0.5" aria-label="Post Message">
            <span class="text-2xl select-none">‚ûï</span>
            <span class="text-sm">Post</span>
        </a>

        <a href="notifications.html" class="flex flex-col items-center gap-0.5" aria-label="Notifications">
            <span class="text-2xl select-none">‚úâÔ∏é</span>
            <span class="text-sm">Alerts</span>
        </a>

        <a href="profile.html" class="flex flex-col items-center gap-0.5" aria-label="Profile">
            <span class="text-2xl select-none">üë§</span>
            <span class="text-sm">Profile</span>
        </a>

    </nav>

    <!-- Firebase & JS -->
    <script type="module">
        import { db, auth } from './firebase-config.js';
        import { collection, addDoc, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        const form = document.getElementById('messageForm');
        const status = document.getElementById('status');
        const posting = document.getElementById('posting');
        const error = document.getElementById('error');

        let currentUser = null;
        let cachedLocation = null;

        // Try loading cached location from sessionStorage
        function loadCachedLocation() {
            const lat = sessionStorage.getItem('userLat');
            const lon = sessionStorage.getItem('userLon');
            if (lat && lon) {
                cachedLocation = {
                    latitude: parseFloat(lat),
                    longitude: parseFloat(lon)
                };
                return true;
            }
            return false;
        }

        // If no cached location, request location once and save to sessionStorage
        function requestLocationOnce() {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        cachedLocation = pos.coords;
                        sessionStorage.setItem('userLat', cachedLocation.latitude);
                        sessionStorage.setItem('userLon', cachedLocation.longitude);
                        resolve();
                    },
                    (err) => {
                        reject("Location permission is required to post messages.");
                    }
                );
            });
        }

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "index.html";
                return;
            }
            currentUser = user;

            // Try to load cached location first
            if (!loadCachedLocation()) {
                // If missing, request once and cache it
                try {
                    await requestLocationOnce();
                } catch (errMsg) {
                    alert(errMsg);
                }
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            error.classList.add("hidden");
            status.classList.add("hidden");

            const title = form.title.value.trim();
            const description = form.description.value.trim();
            const customLocation = form.customLocation.value.trim();
            const distance = parseFloat(form.distance.value);
            const expiry = parseInt(form.expiry.value);
            const category = form.category.value;

            if (!title || !description || !category) {
                alert("Please fill in all required fields.");
                return;
            }
            if (distance > 20 || expiry > 24 || distance < 0.1 || expiry < 1) {
                alert("Max distance is 20km and max expiry time is 24 hours.");
                return;
            }
            if (!cachedLocation) {
                alert("Getting your location. Please wait a moment and try again.");
                // Optionally trigger location request here again:
                try {
                    await requestLocationOnce();
                } catch (errMsg) {
                    alert(errMsg);
                }
                return;
            }

            try {
                posting.classList.remove("hidden");

                await addDoc(collection(db, "messages"), {
                    uid: currentUser.uid,
                    title,
                    description,
                    customLocation,
                    latitude: cachedLocation.latitude,
                    longitude: cachedLocation.longitude,
                    category,
                    distance,
                    likes: [],
                    comments: [],
                    createdAt: serverTimestamp(),
                    expiresAt: Timestamp.fromDate(new Date(Date.now() + expiry * 3600 * 1000))
                });

                form.reset();
                posting.classList.add("hidden");
                status.classList.remove("hidden");

                setTimeout(() => status.classList.add("hidden"), 3000);
            } catch (err) {
                posting.classList.add("hidden");
                error.classList.remove("hidden");
                setTimeout(() => error.classList.add("hidden"), 4000);
                console.error("Error posting message:", err);
            }
        });
    </script>

</body>

</html>